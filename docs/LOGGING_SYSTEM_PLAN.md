# ğŸ“„ æ—¥å¿—ç³»ç»ŸåŠŸèƒ½è§„åˆ’ (Logging System Plan)

## 1. æ¦‚è¿° (Overview)

ä¸º `ClassSidebar` åº”ç”¨è®¾è®¡å¹¶å®ç°ä¸€ä¸ªå…¨é¢ã€å¯é çš„æ—¥å¿—ç³»ç»Ÿã€‚è¯¥ç³»ç»Ÿæ—¨åœ¨é›†ä¸­æ”¶é›†æ¥è‡ªä¸»è¿›ç¨‹ (Main Process) å’Œæ¸²æŸ“è¿›ç¨‹ (Renderer Process) çš„æ—¥å¿—ä¿¡æ¯ï¼Œå°†å…¶è¾“å‡ºåˆ°æœ¬åœ°æ–‡ä»¶ï¼Œå¹¶æä¾›ä¾¿æ·çš„æ—¥å¿—æŸ¥çœ‹ä¸ç®¡ç†åŠŸèƒ½ã€‚è¿™å°†æå¤§åœ°æå‡å¼€å‘è°ƒè¯•æ•ˆç‡å’Œç”¨æˆ·æ”¯æŒèƒ½åŠ›ã€‚

æœ¬é¡¹ç›®æ¨èä½¿ç”¨ `electron-log` ä½œä¸ºæ ¸å¿ƒæ—¥å¿—åº“ï¼Œå®ƒä¸“ä¸º Electron åº”ç”¨è®¾è®¡ï¼ŒåŠŸèƒ½å¼ºå¤§ä¸”æ˜“äºé›†æˆã€‚

## 2. ç”¨æˆ·æ•…äº‹ (User Stories)

*   **ä½œä¸ºå¼€å‘è€…**ï¼Œæˆ‘å¸Œæœ›åœ¨ä¸€ä¸ªç»Ÿä¸€çš„æ—¥å¿—æ–‡ä»¶ä¸­æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹ï¼ˆä¸»è¿›ç¨‹ã€ä¾§è¾¹æ ã€è®¾ç½®çª—å£ï¼‰çš„è¾“å‡ºï¼Œä»¥ä¾¿å¿«é€Ÿè¿½è¸ªå’Œå®šä½é—®é¢˜ã€‚
*   **ä½œä¸ºå¼€å‘è€…**ï¼Œæˆ‘å¸Œæœ›åº”ç”¨ä¸­æœªè¢«æ•è·çš„å¼‚å¸¸ï¼ˆUncaught Exceptionsï¼‰èƒ½è¢«è‡ªåŠ¨è®°å½•åˆ°æ—¥å¿—ä¸­ï¼Œé˜²æ­¢é—®é¢˜è¢«é™é»˜å¿½ç•¥ã€‚
*   **ä½œä¸ºç”¨æˆ·**ï¼Œå½“åº”ç”¨å‡ºç°æ•…éšœæ—¶ï¼Œæˆ‘å¸Œæœ›èƒ½è½»æ¾åœ°åœ¨è®¾ç½®é¡µé¢æ‰¾åˆ°â€œæ‰“å¼€æ—¥å¿—ç›®å½•â€çš„æŒ‰é’®ï¼Œæ–¹ä¾¿æˆ‘å°†æ—¥å¿—æ–‡ä»¶æä¾›ç»™å¼€å‘è€…ã€‚
*   **ä½œä¸ºé«˜çº§ç”¨æˆ·**ï¼Œæˆ‘å¸Œæœ›å¯ä»¥è°ƒæ•´æ—¥å¿—çš„è®°å½•çº§åˆ«ï¼ˆå¦‚ä» `info` åˆ‡æ¢åˆ° `debug`ï¼‰ï¼Œä»¥è¿›è¡Œæ›´æ·±å…¥çš„è¯Šæ–­ã€‚

## 3. åŠŸèƒ½éœ€æ±‚ (Functional Requirements)

### 3.1 æ—¥å¿—æ ¸å¿ƒåŠŸèƒ½
*   **ç»Ÿä¸€æ—¥å¿—ç›®æ ‡**: ä¸»è¿›ç¨‹å’Œæ‰€æœ‰æ¸²æŸ“è¿›ç¨‹çš„æ—¥å¿—å‡å†™å…¥åˆ°åŒä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚
*   **å¤šçº§æ—¥å¿—**: æ”¯æŒæ ‡å‡†æ—¥å¿—çº§åˆ«ï¼š`error`, `warn`, `info`, `verbose`, `debug`ã€‚
*   **æ–‡ä»¶å­˜å‚¨**:
    *   æ—¥å¿—æ–‡ä»¶å­˜å‚¨äºç”¨æˆ·æ•°æ®ç›®å½• (`%APPDATA%/class-sidebar/logs/`)ï¼Œé¿å…æƒé™é—®é¢˜ã€‚
    *   é»˜è®¤æ–‡ä»¶åä¸º `main.log`ã€‚
*   **æ—¥å¿—è½®è½¬ (Rotation)**: å½“å•ä¸ªæ—¥å¿—æ–‡ä»¶è¾¾åˆ°é¢„è®¾å¤§å°ï¼ˆå¦‚ 2MBï¼‰æ—¶ï¼Œè‡ªåŠ¨å°†å…¶é‡å‘½åä¸º `main.old.log` å¹¶åˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶ï¼Œé˜²æ­¢æ—¥å¿—æ–‡ä»¶æ— é™å¢å¤§ã€‚
*   **è‡ªåŠ¨å¼‚å¸¸æ•è·**: è‡ªåŠ¨è®°å½•ä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹ä¸­æ‰€æœ‰æœªå¤„ç†çš„å¼‚å¸¸å’Œ Promise rejectionsã€‚
*   **æ—¥å¿—æ ¼å¼**: æ¯æ¡æ—¥å¿—åº”åŒ…å« `[æ—¶é—´æˆ³] [çº§åˆ«] [è¿›ç¨‹å] å†…å®¹`ï¼Œä¾‹å¦‚ï¼š
    `[2026-01-19 15:30:00.123] [info] [main] SystemToolManager: Executing tool 'taskmgr'`

### 3.2 UI é›†æˆ
*   åœ¨â€œè®¾ç½®â€é¡µé¢çš„â€œç³»ç»Ÿå·¥å…·ç®±â€ä¸‹æ–¹æˆ–æ–°çš„â€œå…³äºâ€é¡µé¢ï¼Œæ·»åŠ ä¸€ä¸ªâ€œæ—¥å¿—ä¸è¯Šæ–­â€åŒºåŸŸã€‚
*   è¯¥åŒºåŸŸåŒ…å«ä¸€ä¸ªæŒ‰é’®ï¼š**â€œæ‰“å¼€æ—¥å¿—ç›®å½• (Open Log Directory)â€**ã€‚
*   ç‚¹å‡»è¯¥æŒ‰é’®ï¼Œåº”é€šè¿‡ä¸»è¿›ç¨‹è°ƒç”¨ `shell.openPath()` æ‰“å¼€æ—¥å¿—æ–‡ä»¶æ‰€åœ¨çš„æ–‡ä»¶å¤¹ã€‚

## 4. æŠ€æœ¯æ¶æ„ (Technical Architecture)

### 4.1 æ ¸å¿ƒåº“
*   **`electron-log`**: åº”ç”¨çš„æ ¸å¿ƒæ—¥å¿—åº“ã€‚
    *   ä¸»è¿›ç¨‹ä¸­ä½¿ç”¨ `electron-log`ã€‚
    *   æ¸²æŸ“è¿›ç¨‹ä¸­ä½¿ç”¨ `electron-log/renderer`ï¼Œå®ƒé€šè¿‡ IPC å°†æ—¥å¿—æ¶ˆæ¯å‘é€åˆ°ä¸»è¿›ç¨‹è¿›è¡Œå¤„ç†å’Œå†™å…¥ã€‚

### 4.2 æ¨¡å—åŒ–è®¾è®¡
å»ºè®®åœ¨ä¸»è¿›ç¨‹ä¸­åˆ›å»ºä¸€ä¸ª `Logger.ts` æ¨¡å—ï¼Œç”¨äºç»Ÿä¸€é…ç½®å’Œåˆå§‹åŒ– `electron-log`ã€‚

```typescript
// src/main/Logger.ts (ä¼ªä»£ç )
import log from 'electron-log';
import { app } from 'electron';
import path from 'path';

export function initializeLogger() {
  // 1. é…ç½®æ—¥å¿—æ–‡ä»¶è·¯å¾„
  log.transports.file.resolvePath = () => path.join(app.getPath('userData'), 'logs/main.log');

  // 2. é…ç½®æ—¥å¿—æ ¼å¼
  log.transports.file.format = '[{y}-{m}-{d} {h}:{i}:{s}.{ms}] [{level}] [{processType}] {text}';

  // 3. è®¾ç½®æ–‡ä»¶å¤§å°ä¸Šé™ (2MB)
  log.transports.file.maxSize = 2 * 1024 * 1024;

  // 4. è®¾ç½®æ—¥å¿—çº§åˆ« (å¼€å‘ç¯å¢ƒ debug, ç”Ÿäº§ç¯å¢ƒ info)
  log.transports.file.level = app.isPackaged ? 'info' : 'debug';
  log.transports.console.level = app.isPackaged ? 'info' : 'debug';

  // 5. æ•è·å…¨å±€æœªå¤„ç†å¼‚å¸¸
  log.catchErrors();

  // 6. æ›¿æ¢ console.log ç­‰
  Object.assign(console, log.functions);

  log.info('Logger initialized.');
}
```

### 4.3 IPC é€šä¿¡
*   åˆ›å»ºä¸€ä¸ªæ–°çš„ IPC é€šé“ `logs:open-directory`ã€‚
*   å‰ç«¯ï¼ˆè®¾ç½®é¡µé¢ï¼‰ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œè°ƒç”¨ `window.electronAPI.openLogDirectory()`ã€‚
*   ä¸»è¿›ç¨‹ç›‘å¬è¯¥äº‹ä»¶ï¼Œå¹¶ä½¿ç”¨ `shell.openPath(log.transports.file.getFile().path)` æ‰“å¼€æ—¥å¿—æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ã€‚

## 5. å¼€å‘ä»»åŠ¡æ¸…å• (Task List)

- [ ] **ç¯å¢ƒå‡†å¤‡**:
    - [ ] å®‰è£…ä¾èµ–: `npm install electron-log`
- [ ] **ä¸»è¿›ç¨‹ (Main Process)**:
    - [ ] åˆ›å»º `src/main/Logger.ts` æ¨¡å—å¹¶å®ç° `initializeLogger` å‡½æ•°ã€‚
    - [ ] åœ¨ä¸»å…¥å£æ–‡ä»¶ (`background.ts`) çš„ `app.whenReady()` ä¸­è°ƒç”¨ `initializeLogger()`ã€‚
    - [ ] å®ç° `logs:open-directory` çš„ IPC Handlerã€‚
    - [ ] å°†ç°æœ‰ä»£ç ä¸­çš„å…³é”® `console.log` æ›¿æ¢ä¸º `log.info`, `log.warn`, `log.error`ã€‚
- [ ] **æ¸²æŸ“è¿›ç¨‹ (Renderer Process)**:
    - [ ] åœ¨ `preload` è„šæœ¬ä¸­æš´éœ² `openLogDirectory` APIã€‚
    - [ ] åœ¨ `QuickActions.vue` æˆ–æ–°å»ºçš„ç»„ä»¶ä¸­ï¼Œæ·»åŠ â€œæ‰“å¼€æ—¥å¿—ç›®å½•â€æŒ‰é’®åŠå…¶ç‚¹å‡»äº‹ä»¶ã€‚
    - [ ] (å¯é€‰) åˆ›å»ºä¸€ä¸ª `src/renderer/src/utils/logger.ts` æ¨¡å—ï¼Œå°è£… `electron-log/renderer`ï¼Œæ–¹ä¾¿åœ¨ Vue ç»„ä»¶ä¸­ç»Ÿä¸€è°ƒç”¨ã€‚
- [ ] **æµ‹è¯•**:
    - [ ] å¯åŠ¨åº”ç”¨ï¼Œç¡®è®¤æ—¥å¿—æ–‡ä»¶å·²åœ¨ `%APPDATA%/class-sidebar/logs/` ç›®å½•ä¸‹åˆ›å»ºã€‚
    - [ ] åœ¨ä¸»è¿›ç¨‹å’Œæ¸²æŸ“è¿›ç¨‹ä¸­åˆ†åˆ«è§¦å‘æ—¥å¿—è®°å½•ï¼Œæ£€æŸ¥æ—¥å¿—æ–‡ä»¶å†…å®¹å’Œæ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚
    - [ ] åœ¨è®¾ç½®é¡µé¢ç‚¹å‡»æŒ‰é’®ï¼ŒéªŒè¯æ˜¯å¦èƒ½æ­£ç¡®æ‰“å¼€æ—¥å¿—ç›®å½•ã€‚
    - [ ] æ•…æ„åˆ¶é€ ä¸€ä¸ªæœªæ•è·çš„å¼‚å¸¸ï¼Œæ£€æŸ¥æ˜¯å¦è¢« `log.catchErrors()` æ•è·å¹¶è®°å½•ã€‚

## 6. æ³¨æ„äº‹é¡¹ (Notes)
*   **éšç§å®‰å…¨**: ç»å¯¹ä¸è¦è®°å½•ä»»ä½•æ•æ„Ÿä¿¡æ¯ï¼Œå¦‚ç”¨æˆ·å¯†ç ã€API å¯†é’¥æˆ–è¯¦ç»†çš„æ–‡ä»¶è·¯å¾„ã€‚
*   **æ€§èƒ½**: åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œåº”å°†æ—¥å¿—çº§åˆ«è®¾ç½®ä¸º `info` æˆ– `warn`ï¼Œé¿å… `debug` çº§åˆ«çš„æ—¥å¿—è¿‡å¤šå½±å“æ€§èƒ½ã€‚
*   **æ—¥å¿—æ¸…ç†**: è§„åˆ’ä¸­åªä¿ç•™ä¸€ä¸ªæ—§æ—¥å¿— (`.old.log`)ï¼Œå¯¹äºé•¿æœŸè¿è¡Œçš„åº”ç”¨ï¼Œæœªæ¥å¯è€ƒè™‘å®ç°æ›´å¤æ‚çš„å½’æ¡£ç­–ç•¥ï¼ˆå¦‚ä¿ç•™æœ€è¿‘7å¤©çš„æ—¥å¿—ï¼‰ã€‚